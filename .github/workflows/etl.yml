# name: ETL-Train-Deploy

# on:
#   schedule:
#     - cron: "0 * * * *"
#   workflow_dispatch:

# env:
#   PYTHON_VERSION: "3.11"
#   IMAGE_NAME: cost-forecast-api
#   DO_REGISTRY: ${{ secrets.DO_REGISTRY }}
#   MODEL_ARTIFACT_DIR: artifacts/model
#   MODEL_ARTIFACT_PATH: artifacts/model/tft_cost_forecast.ckpt

# jobs:
#   run-etl:
#     runs-on: etl-runner
#     permissions:
#       contents: read
#       id-token: write
#     env:
#       GCP_PROJECT_ID: buoyant-episode-386713
#       BIGQUERY_DATASET: all_billing_data
#       GCP_BILLING_TABLE_PATTERN: gcp_billing_export_resource_v1_*
#       GCP_POSTGRES_CONN: ${{ secrets.GCP_POSTGRES_CONN }}
#       AZURE_POSTGRES_CONN: ${{ secrets.AZURE_POSTGRES_CONN }}
#       AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
#       AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
#       AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
#       AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
#     steps:
#       - uses: actions/checkout@v4

#       - uses: actions/setup-python@v5
#         with:
#           python-version: ${{ env.PYTHON_VERSION }}

#       - id: auth
#         uses: google-github-actions/auth@v2
#         with:
#           credentials_json: ${{ secrets.GOOGLE_CREDENTIALS }}

#       - name: Install dependencies
#         run: pip install --no-cache-dir -r requirements.txt

#       - name: Run ETL
#         env:
#           GOOGLE_PROJECT_ID: ${{ env.GCP_PROJECT_ID }}
#         run: python ETL.py

#   train-model:
#     needs: run-etl
#     runs-on: gpu-training-runner
#     env:
#       MODEL_ARTIFACT_PATH: ${{ env.MODEL_ARTIFACT_PATH }}
#       POSTGRES_CONN_STR: ${{ secrets.POSTGRES_CONN_STR }}
#     steps:
#       - uses: actions/checkout@v4

#       - uses: actions/setup-python@v5
#         with:
#           python-version: ${{ env.PYTHON_VERSION }}

#       - name: Install training dependencies
#         run: pip install --no-cache-dir -r requirements.txt

#       - name: Train Temporal Fusion Transformer
#         run: python -m src.training.tft

#       - name: Upload model artifact
#         uses: actions/upload-artifact@v4
#         with:
#           name: tft-model
#           path: ${{ env.MODEL_ARTIFACT_DIR }}
#           if-no-files-found: error
#           retention-days: 5

#   build-and-push-image:
#     needs: train-model
#     runs-on: etl-runner
#     env:
#       IMAGE_TAG: ${{ github.sha }}
#     outputs:
#       image_ref: ${{ steps.image-ref.outputs.image_ref }}
#     steps:
#       - uses: actions/checkout@v4

#       - name: Download trained model artifact
#         uses: actions/download-artifact@v4
#         with:
#           name: tft-model
#           path: ${{ env.MODEL_ARTIFACT_DIR }}

#       - name: Log in to DigitalOcean Container Registry
#         uses: docker/login-action@v3
#         with:
#           registry: ${{ env.DO_REGISTRY }}
#           username: ${{ secrets.DO_REGISTRY_USERNAME }}
#           password: ${{ secrets.DO_REGISTRY_TOKEN }}

#       - name: Build FastAPI image
#         run: |
#           docker build \
#             -t ${{ env.DO_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
#             -f Dockerfile .

#       - name: Push FastAPI image
#         run: |
#           docker push ${{ env.DO_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

#       - name: Set image reference output
#         id: image-ref
#         run: echo "image_ref=${{ env.DO_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" >> "$GITHUB_OUTPUT"

#   deploy-api:
#     needs: build-and-push-image
#     runs-on: do-deploy-runner
#     env:
#       IMAGE_REF: ${{ needs.build-and-push-image.outputs.image_ref }}
#     steps:
#       - name: Download model artifact backup
#         uses: actions/download-artifact@v4
#         with:
#           name: tft-model
#           path: artifacts/model

#       - name: Persist model artifact on runner
#         run: |
#           mkdir -p $HOME/cost-forecast/model
#           cp artifacts/model/tft_cost_forecast.ckpt $HOME/cost-forecast/model/tft_cost_forecast.ckpt

#       - name: Log in to DigitalOcean Container Registry
#         uses: docker/login-action@v3
#         with:
#           registry: ${{ env.DO_REGISTRY }}
#           username: ${{ secrets.DO_REGISTRY_USERNAME }}
#           password: ${{ secrets.DO_REGISTRY_TOKEN }}

#       - name: Pull and restart API container
#         run: |
#           docker pull $IMAGE_REF
#           docker stop cost-forecast-api || true
#           docker rm cost-forecast-api || true
#           docker run -d --name cost-forecast-api \
#             --restart unless-stopped \
#             -p 8000:8000 \
#             $IMAGE_REF
